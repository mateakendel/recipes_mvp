<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Home</title>

   <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

</head>

<body>

<div class="page">

    <header class="page-header">
        <h1>Welcome to Recipes app</h1>
        <div class="header-actions">
            <a class="back-link" href="/all-recipes">View all recipes</a>
            <button class="secondary small" onclick="logout()">Logout</button>
        </div>
    </header>

    <section class="form-card">
        <h3> Add recipe</h3>

        <div class="form-grid">
            <input id="title" placeholder="Title">

            <select id="category">
                <option value="">-- Select category --</option>
                <option value="Predjelo">Predjelo</option>
                <option value="Glavno jelo">Glavno jelo</option>
                <option value="Desert">Desert</option>
                <option value="Piće">Piće</option>
                <option value="Salata">Salata</option>
            </select>

            <textarea id="ingredients" placeholder="Ingredients (one per line)"></textarea>
            <textarea id="steps" placeholder="Preparation steps"></textarea>
        </div>

        <button class="primary" onclick="addRecipe()">Add Recipe</button>
    </section>

    <section class="results">
        <h3>My recipes</h3>
        <div id="recipes">
            <em>Loading recipes...</em>
        </div>
    </section>

</div>

<script>
const CURRENT_USER = localStorage.getItem("username");

if (!CURRENT_USER) {
    window.location.href = "/";
}

function addRecipe() {
    fetch("/recipes", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            title: document.getElementById("title").value,
            ingredients: document.getElementById("ingredients").value.split("\n"),
            steps: document.getElementById("steps").value,
            category: document.getElementById("category").value,
            author: CURRENT_USER
        })
    }).then(() => {
        clearForm();
        loadMyRecipes();
    });
}

function loadMyRecipes() {
    fetch(`/recipes?mode=mine&user=${encodeURIComponent(CURRENT_USER)}`)
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById("recipes");
            container.innerHTML = "";

            if (data.length === 0) {
                container.innerHTML = "<em>No recipes yet</em>";
                return;
            }

            data.forEach(r => {
                const div = document.createElement("div");
                div.className = "recipe-card";
                div.innerHTML = `
                    <a href="/recipe/${r._id}" class="recipe-title">
                        ${r.title}
                    </a>
                    <div class="recipe-meta">
                        <span class="category">${r.category}</span>
                        <span class="author">by ${r.author}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        });
}

function clearForm() {
    document.getElementById("title").value = "";
    document.getElementById("ingredients").value = "";
    document.getElementById("steps").value = "";
    document.getElementById("category").value = "";
}

function logout() {
    localStorage.removeItem("username");
    window.location.href = "/";
}

loadMyRecipes();
</script>

</body>
</html>
